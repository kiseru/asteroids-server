package com.kiseru.asteroids.server.handler

import java.net.Socket

/**
 * Обработчик клиентского соединения.
 *
 * Обеспечивает обмен сообщениями с клиентом через сокет:
 * - приём команд;
 * - отправку ответов.
 *
 * @param socket Сетевое соединение с клиентом.
 */
class ConnectionHandler(socket: Socket) {

    /** Буферизированный читатель для приёма данных от клиента. */
    private val reader = socket.getInputStream().bufferedReader()

    /** Буферизированный писатель для отправки данных клиенту. */
    private val writer = socket.getOutputStream().bufferedWriter()

    /**
     * Принимает и преобразует команду от клиента в объект перечисления [Command].
     *
     * Процесс выполнения:
     * 1. Вызывает [receiveMessage] для получения текстовой строки от клиента.
     * 2. Пытается преобразовать полученную строку в значение перечисления [Command]
     *    с помощью [Command.valueOf].
     * 3. При успешном преобразовании возвращает соответствующий объект [Command].
     * 4. При ошибке (неизвестная команда или null) возвращает `null`.
     *
     * @return
     *   - Объект [Command], если строка соответствует одному из значений перечисления.
     *   - `null`, если:
     *     - получено `null` (клиент закрыл соединение);
     *     - строка пуста или состоит только из пробелов;
     *     - строка не соответствует ни одному значению [Command].
     *
     * @throws java.io.IOException При ошибке ввода‑вывода в процессе чтения сообщения
     *   (пробрасывается из [receiveMessage]).
     *
     * @note
     *   - Использует [receiveMessage] для получения строки от клиента.
     *   - При ошибке преобразования (например, неизвестная команда) возвращает `null`
     *     без проброса исключения.
     */
    fun receiveCommand(): Command? =
        try {
            val command = receiveMessage()
            if (command.isNullOrBlank()) {
                null
            } else {
                Command.valueOf(command.trim())
            }
        } catch (_: IllegalArgumentException) {
            null
        }

    /**
     * Читает одну строку сообщения от клиента.
     *
     * @return
     *   - Полученная строка, если чтение прошло успешно;
     *   - `null`, если:
     *     - соединение закрыто клиентом;
     *     - достигнут конец потока (EOF);
     *     - произошла ошибка ввода‑вывода (в этом случае также будет выброшено исключение).
     *
     * @throws java.io.IOException
     *   Если возникла ошибка при чтении из сокета (например, разрыв соединения,
     *   проблемы с сетью или недоступность ресурса).
     *
     * @note
     *   - Метод блокирует выполнение до поступления данных или возникновения ошибки.
     *   - Возвращаемое значение `null` однозначно указывает на закрытие соединения
     *     или завершение потока со стороны клиента.
     *   - Для неблокирующего чтения рассмотрите использование асинхронных механизмов
     *     или таймаутов на уровне сокета.
     */
    fun receiveMessage(): String? =
        reader.readLine()

    /**
     * Отправляет сообщение клиенту.
     *
     * @param message Текст сообщения для отправки.
     *
     * @note
     *   - Добавляет символ перевода строки (`\n`) после сообщения.
     *   - Выполняет принудительную отправку данных через [flush].
     *
     * @throws java.io.IOException При проблемах с записью в сокет.
     */
    fun sendMessage(message: String) {
        writer.appendLine(message)
        writer.flush()
    }
}

